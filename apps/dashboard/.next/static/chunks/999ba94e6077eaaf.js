(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,72708,e=>{"use strict";var t=e.i(43476),s=e.i(71645),r=e.i(18566),a=e.i(14949);function n(){let e=(0,r.useParams)();(0,r.useRouter)();let n=e.magicCode,[i,l]=(0,s.useState)(null),[o,d]=(0,s.useState)([]),[c,h]=(0,s.useState)(""),[u,m]=(0,s.useState)(!1),[x,g]=(0,s.useState)(!0),p=(0,s.useRef)(null),y="http://localhost:3000",b=(0,a.getSupabaseClient)();(0,s.useEffect)(()=>{n&&(async()=>{try{let e=await fetch(`${y}/customers/magic/${n}`);if(e.ok){let t=await e.json();l(t),t.threadId&&f(t.threadId)}else console.error("Customer not found")}catch(e){console.error("Error initializing customer:",e)}finally{g(!1)}})()},[n,y]);let f=async e=>{try{let t=await fetch(`${y}/messages/thread/${e}`);if(t.ok){let e=await t.json(),s=Array.isArray(e)?e:[];d(s)}}catch(e){console.error("Error loading messages:",e)}};(0,s.useEffect)(()=>{if(!i?.threadId)return;let e=b.channel(`thread-${i.threadId}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"shop_messages",filter:`thread_id=eq.${i.threadId}`},e=>{let t=e.new;d(e=>[...e,t])}).subscribe();return()=>{b.removeChannel(e)}},[i?.threadId,b]),(0,s.useEffect)(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[o]);let j=(0,s.useRef)(null),N=async e=>{if(e.preventDefault(),!c.trim()||u||!i)return;let t=c.trim();h(""),m(!0);try{(await fetch(`${y}/messages/thread/${i.threadId}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderType:"customer",content:t})})).ok&&await fetch(`${y}/ai/chat-thread`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:i.threadId,shopId:i.shopId,message:t,source:"customer"})})}catch(e){console.error("Error sending message:",e)}finally{m(!1),setTimeout(()=>{j.current?.focus()},100)}};return x?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Loading your chat..."})]})}):i?(0,t.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col",children:[(0,t.jsx)("div",{className:"bg-white shadow-sm border-b border-gray-200 px-6 py-4",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,t.jsxs)("h1",{className:"text-2xl font-bold text-gray-900",children:[i.customer_id_display,"さん"]}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Your permanent chat"})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto px-4 py-6",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto space-y-4",children:[o.map(e=>(0,t.jsx)("div",{className:`flex ${"customer"===e.sender_type?"justify-end":"justify-start"}`,children:(0,t.jsxs)("div",{className:`max-w-[80%] rounded-lg px-4 py-2 ${"customer"===e.sender_type?"bg-blue-600 text-white":"owner"===e.sender_type?"bg-purple-600 text-white":"bg-white text-gray-900 border border-gray-200"}`,children:[(0,t.jsx)("p",{className:"text-sm",children:e.translatedContent||e.content}),e.originalContent&&e.originalContent!==e.translatedContent&&(0,t.jsxs)("p",{className:"text-xs mt-1 opacity-75 italic",children:[e.originalContent.substring(0,50),"..."]})]})},e.id)),(0,t.jsx)("div",{ref:p})]})}),(0,t.jsx)("div",{className:"bg-white border-t border-gray-200 px-4 py-4",children:(0,t.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,t.jsxs)("form",{onSubmit:N,className:"flex gap-2",children:[(0,t.jsx)("input",{ref:j,type:"text",value:c,onChange:e=>h(e.target.value),placeholder:"Type your message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:u,autoFocus:!0}),(0,t.jsx)("button",{type:"submit",disabled:u||!c.trim(),className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Sending...":"Send"})]})})})]}):(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Chat Not Found"}),(0,t.jsx)("p",{className:"text-gray-600",children:"This chat link is invalid or has expired."})]})})}e.s(["default",()=>n])}]);
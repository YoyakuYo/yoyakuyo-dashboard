(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,66006,e=>{"use strict";var t=e.i(43476),s=e.i(71645),r=e.i(63611),a=e.i(14949),n=e.i(48148);function l(){let{user:e}=(0,r.useAuth)(),l=(0,n.useTranslations)(),[i,o]=(0,s.useState)([]),[d,c]=(0,s.useState)(null),[u,m]=(0,s.useState)([]),[g,x]=(0,s.useState)(""),[h,y]=(0,s.useState)(!1),[f,b]=(0,s.useState)(!0),[p,j]=(0,s.useState)(null),[w,v]=(0,s.useState)(!1),[N,C]=(0,s.useState)(!1),[T,S]=(0,s.useState)(new Set),[k,$]=(0,s.useState)("en"),E=(0,s.useRef)(null),_=(0,s.useRef)(null),A=(0,s.useRef)(null),O="http://localhost:3000";(0,s.useEffect)(()=>{E.current?.scrollIntoView({behavior:"smooth"})},[u]),(0,s.useEffect)(()=>{e?.id&&(I(),P())},[e]);let P=async()=>{try{let t=await fetch(`${O}/users/me`,{headers:{"x-user-id":e?.id||""}});if(t.ok){let e=await t.json();$(e.preferredLanguage||"en")}}catch(e){console.error("Error loading owner preferences:",e)}};(0,s.useEffect)(()=>(d&&(F(d),L(d),D(d)),()=>{_.current&&(0,a.getSupabaseClient)().removeChannel(_.current)}),[d]),(0,s.useEffect)(()=>()=>{_.current&&(0,a.getSupabaseClient)().removeChannel(_.current)},[]);let I=async()=>{try{b(!0);let t=await fetch(`${O}/messages/owner/threads`,{headers:{"x-user-id":e?.id||""}});if(t.ok){let e=await t.json();o(Array.isArray(e)?e:[])}else console.error("Failed to load threads"),o([])}catch(e){console.error("Error loading threads:",e),o([])}finally{b(!1)}},F=async e=>{try{let t=await fetch(`${O}/messages/thread/${e}`);if(t.ok){let s=await t.json(),r=Array.isArray(s)?s:[],a=i.find(t=>t.id===e);a&&v(a.ownerTakenOver||!1);let n=await Promise.all(r.map(async e=>{if("owner"===e.senderType)return{...e,originalContent:e.originalContent||e.content,translatedContent:e.content};if("customer"===e.senderType||"ai"===e.senderType){if(e.content&&!e.translatedContent)try{let t=await fetch(`${O}/ai/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e.content,targetLanguage:k,sourceLanguage:"auto"})});if(t.ok){let s=await t.json();return{...e,originalContent:e.content,translatedContent:s.translatedText||e.content,detectedLanguage:s.sourceLanguage}}}catch(e){console.error("Error translating message:",e)}return{...e,originalContent:e.content,translatedContent:e.translatedContent||e.content}}return e}));m(n)}}catch(e){console.error("Error loading messages:",e)}},M=async()=>{if(!d)return;let e=!w;v(e);try{(await fetch(`${O}/messages/thread/${d}/takeover`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({takenOver:e})})).ok?o(t=>t.map(t=>t.id===d?{...t,ownerTakenOver:e}:t)):(v(!e),console.error("Failed to toggle takeover"))}catch(t){console.error("Error toggling takeover:",t),v(!e)}},D=async e=>{try{await fetch(`${O}/messages/thread/${e}/mark-read-owner`,{method:"POST"}),o(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t))}catch(e){console.error("Error marking as read:",e)}},L=e=>{_.current=(0,a.getSupabaseClient)().channel(`shop_messages:thread_id=eq.${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"shop_messages",filter:`thread_id=eq.${e}`},async t=>{let s=t.new;s&&s.thread_id===e&&(m(e=>{if(e.some(e=>e.id===s.id))return e;let t={id:s.id,senderType:s.sender_type,content:s.content,createdAt:s.created_at,readByOwner:s.read_by_owner||!1,readByCustomer:s.read_by_customer||!1,senderId:s.sender_id||null,originalContent:s.content,translatedContent:s.content};return("customer"===s.sender_type||"ai"===s.sender_type)&&fetch(`${O}/ai/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:s.content,targetLanguage:k,sourceLanguage:"auto"})}).then(e=>e.json()).then(e=>{m(t=>t.map(t=>t.id===s.id?{...t,translatedContent:e.translatedText||t.content,detectedLanguage:e.sourceLanguage}:t))}).catch(e=>console.error("Error translating new message:",e)),[...e,t]}),o(t=>t.map(t=>t.id===e?{...t,lastMessageAt:s.created_at,lastMessagePreview:s.content?.substring(0,100)||null,lastMessageFrom:s.sender_type,unreadCount:"customer"!==s.sender_type||s.read_by_owner?t.unreadCount:t.unreadCount+1}:t)))}).subscribe()};(0,s.useEffect)(()=>(g.trim()&&d?(C(!0),A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{C(!1)},2e3)):C(!1),()=>{A.current&&clearTimeout(A.current)}),[g,d]);let R=(0,s.useRef)(null),J=async t=>{if(t.preventDefault(),!g.trim()||h||!d)return;C(!1);let s=g.trim();x(""),y(!0),j(null);try{let t=await fetch(`${O}/messages/thread/${d}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderType:"owner",senderId:e?.id||null,content:s})});if(!t.ok){let e=await t.json().catch(()=>({error:"Failed to send message"}));throw Error(e.error||`HTTP error! status: ${t.status}`)}let r=await t.json();m(e=>e.some(e=>e.id===r.id)?e:[...e,r]),o(e=>e.map(e=>e.id===d?{...e,lastMessageAt:r.createdAt,lastMessagePreview:r.content?.substring(0,100)||null,lastMessageFrom:"owner"}:e));let a=i.find(e=>e.id===d);if(a?.shopId)try{await fetch(`${O}/ai/chat-thread`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:d,shopId:a.shopId,message:s,source:"owner"})})}catch(e){console.error("Error triggering AI response:",e)}}catch(e){console.error("Error sending message:",e),j(e instanceof Error?e.message:"Failed to send message")}finally{y(!1),setTimeout(()=>{R.current?.focus()},100)}},B=i.find(e=>e.id===d);return(0,t.jsxs)("div",{className:"p-8 bg-gray-50 min-h-screen",children:[(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:l("assistant.title")}),(0,t.jsx)("p",{className:"text-gray-600",children:l("assistant.subtitle")})]}),(0,t.jsx)("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden",children:(0,t.jsxs)("div",{className:"flex h-[calc(100vh-280px)] min-h-[600px]",children:[(0,t.jsxs)("div",{className:"w-80 border-r border-gray-200 flex flex-col bg-gray-50",children:[(0,t.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 bg-white",children:(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-800",children:l("assistant.customerConversations")})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto bg-white",children:f?(0,t.jsx)("div",{className:"p-6 text-center text-gray-500",children:l("assistant.loadingThreads")}):0===i.length?(0,t.jsx)("div",{className:"p-6 text-center text-gray-500",children:(0,t.jsx)("p",{children:l("assistant.noConversations")})}):(0,t.jsx)("div",{className:"divide-y divide-gray-100",children:i.map(e=>{let s;return(0,t.jsx)("button",{onClick:()=>c(e.id),className:`w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors ${d===e.id?"bg-blue-50 border-l-4 border-blue-600":""}`,children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)("span",{className:"text-lg",children:"ðŸ‘¤"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-gray-900 truncate",children:e.customerEmail||`Thread ${e.id.substring(0,8)}`}),e.unreadCount>0&&(0,t.jsx)("span",{className:"ml-2 flex-shrink-0 bg-blue-600 text-white text-xs font-semibold rounded-full px-2 py-0.5 min-w-[20px] text-center",children:e.unreadCount})]}),e.lastMessagePreview&&(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate mb-1",children:e.lastMessagePreview}),(0,t.jsx)("p",{className:"text-xs text-gray-400",children:(s=new Date(e.lastMessageAt),new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}).format(s))})]})]})},e.id)})})})]}),(0,t.jsx)("div",{className:"flex-1 flex flex-col bg-gray-50",children:d?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 bg-white flex items-center justify-between shadow-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:(0,t.jsx)("span",{className:"text-lg",children:"ðŸ‘¤"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-800",children:B?.customerEmail||`Thread ${d.substring(0,8)}`}),B?.bookingId&&(0,t.jsxs)("p",{className:"text-sm text-gray-500",children:[l("assistant.booking")," ",B.bookingId.substring(0,8)]})]})]}),(0,t.jsx)("button",{onClick:M,className:`px-4 py-2 rounded-lg font-medium transition-colors ${w?"bg-green-600 text-white hover:bg-green-700":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:l(w?"assistant.youAreHandling":"assistant.letAiHandle")})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50",children:0===u.length?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),(0,t.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:l("assistant.noMessages")}),(0,t.jsx)("p",{className:"text-gray-600",children:l("assistant.startConversation")})]})}):(0,t.jsxs)(t.Fragment,{children:[u.map(e=>{let s;return(0,t.jsxs)("div",{className:`flex gap-3 ${"owner"===e.senderType?"justify-end":"justify-start"}`,children:["owner"!==e.senderType&&(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)("span",{className:"text-lg",children:"ai"===e.senderType?"ðŸ¤–":"ðŸ‘¤"})}),(0,t.jsxs)("div",{className:`max-w-[75%] rounded-lg px-4 py-3 shadow-sm ${"owner"===e.senderType?"bg-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,children:[(0,t.jsx)("p",{className:"whitespace-pre-wrap break-words",children:"owner"===e.senderType?e.originalContent||e.content:e.translatedContent||e.content}),("customer"===e.senderType||"ai"===e.senderType)&&e.originalContent&&e.originalContent!==e.translatedContent&&(0,t.jsxs)("p",{className:"text-xs mt-1 opacity-75 italic",children:["ðŸ‡¯ðŸ‡µ ",e.originalContent.substring(0,50),e.originalContent.length>50?"...":""]}),(0,t.jsx)("p",{className:`text-xs mt-2 ${"owner"===e.senderType?"text-blue-100":"text-gray-500"}`,children:(s=new Date(e.createdAt),new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"2-digit"}).format(s))})]}),"owner"===e.senderType&&(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"You"})})]},e.id)}),N&&(0,t.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,t.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}}),(0,t.jsx)("span",{className:"text-xs text-gray-500 ml-2",children:l("assistant.youAreTyping")})]})}),(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"You"})})]}),h&&(0,t.jsxs)("div",{className:"flex gap-3 justify-start",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)("span",{className:"text-lg",children:"ðŸ¤–"})}),(0,t.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),(0,t.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]})})]}),(0,t.jsx)("div",{ref:E})]})}),(0,t.jsxs)("div",{className:"px-6 py-4 border-t border-gray-200 bg-white sticky bottom-0",children:[p&&(0,t.jsx)("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:p}),(0,t.jsxs)("form",{onSubmit:J,className:"flex gap-2",children:[(0,t.jsx)("input",{ref:R,type:"text",value:g,onChange:e=>x(e.target.value),placeholder:l("assistant.typeMessage"),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none",disabled:h,autoFocus:!0}),(0,t.jsx)("button",{type:"submit",disabled:!g.trim()||h,className:"px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:l(h?"assistant.sending":"assistant.send")})]})]})]}):(0,t.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-50",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),(0,t.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:l("assistant.selectConversation")}),(0,t.jsx)("p",{className:"text-gray-600",children:l("assistant.selectConversationDesc")})]})})})]})})]})}e.s(["default",()=>l])}]);
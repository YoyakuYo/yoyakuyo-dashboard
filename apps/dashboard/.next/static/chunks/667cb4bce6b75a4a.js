(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,37561,e=>{"use strict";var s=e.i(43476),t=e.i(71645),a=e.i(18566),r=e.i(48148),l=e.i(14949);function n(){let e=(0,a.useParams)(),n=e?.shopId,o=(0,r.useTranslations)(),[i,d]=(0,t.useState)([]),[c,m]=(0,t.useState)([]),[u,h]=(0,t.useState)([]),[g,x]=(0,t.useState)(null),[b,y]=(0,t.useState)(null),[f,p]=(0,t.useState)(null),[N,j]=(0,t.useState)(""),[v,w]=(0,t.useState)(""),E="http://localhost:3000",[S,k]=(0,t.useState)(null),[_,C]=(0,t.useState)([]),[T,I]=(0,t.useState)(""),[R,O]=(0,t.useState)(!1),[$,F]=(0,t.useState)(!1),A=(0,t.useRef)(null),D=(0,t.useRef)(null),[U,B]=(0,t.useState)(null),[P,L]=(0,t.useState)(null),[q,J]=(0,t.useState)(null);(0,t.useEffect)(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[_]),(0,t.useEffect)(()=>{{let e=localStorage.getItem("yoyaku_yo_anonymous_session");e||(e=`anon_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("yoyaku_yo_anonymous_session",e)),B(e)}},[]),(0,t.useEffect)(()=>{n&&(async()=>{try{let e=await fetch(`${E}/qr/shop/${n}/line`);if(e.ok){let s=await e.json();L(s.qrImageUrl),J(s.deeplinkUrl)}}catch(e){}})()},[n,E]),(0,t.useEffect)(()=>(n&&!S&&U&&(async()=>{try{let e=await fetch(`${E}/messages/start-thread`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shopId:n,bookingId:null,threadType:"customer",anonymousSessionId:U})});if(e.ok){let s=await e.json();k(s.threadId),K(s.threadId),M(s.threadId)}}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error starting thread:",e)}})(),()=>{D.current&&(0,l.getSupabaseClient)().removeChannel(D.current)}),[n,S,E]);let K=async e=>{try{let s=U?`${E}/messages/thread/${e}?anonymousSessionId=${encodeURIComponent(U)}`:`${E}/messages/thread/${e}`,t=await fetch(s);if(t.ok){let e=await t.json();C(Array.isArray(e)?e:[])}}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading messages:",e)}},M=e=>{D.current=(0,l.getSupabaseClient)().channel(`shop_messages:thread_id=eq.${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"shop_messages",filter:`thread_id=eq.${e}`},s=>{let t=s.new;t&&t.thread_id===e&&C(e=>e.some(e=>e.id===t.id)?e:[...e,{id:t.id,senderType:t.sender_type,content:t.content,createdAt:t.created_at,readByOwner:t.read_by_owner||!1,readByCustomer:t.read_by_customer||!1}])}).subscribe()},Q=async()=>{if(!S||!T.trim()||R)return;let e=T.trim();I("");let s=`temp-${Date.now()}`,t={id:s,senderType:"customer",content:e,createdAt:new Date().toISOString(),readByOwner:!1,readByCustomer:!0};C(e=>[...e,t]),O(!0);try{let t=await fetch(`${E}/messages/thread/${S}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderType:"customer",content:e})});if(t.ok){let e=await t.json();C(t=>t.map(t=>t.id===s?{id:e.id,senderType:e.senderType,content:e.content,createdAt:e.createdAt,readByOwner:e.readByOwner,readByCustomer:e.readByCustomer}:t))}else C(e=>e.filter(e=>e.id!==s)),alert("Failed to send message. Please try again.")}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error sending message:",e),C(e=>e.filter(e=>e.id!==s)),e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||alert("Failed to send message. Please try again.")}finally{O(!1)}};(0,t.useEffect)(()=>{let e=async()=>{try{let e=await fetch(`${E}/shops/${n}/staff`);if(e.ok){let s=await e.json();m(Array.isArray(s)?s:[])}else console.error("Failed to fetch staff:",e.status,e.statusText),m([])}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error fetching staff:",e),m([])}};(async()=>{try{let e=await fetch(`${E}/shops/${n}/services`);if(e.ok){let s=await e.json();d(Array.isArray(s)?s:[])}else console.error("Failed to fetch services:",e.status,e.statusText),d([])}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error fetching services:",e),d([])}})(),e()},[n,E]);let V=async()=>{if(f&&b)try{let e=await fetch(`${E}/shops/${n}/availability?date=${f}`);if(e.ok){let s=await e.json();h(Array.isArray(s)?s:[])}else console.error("Failed to fetch availability:",e.status,e.statusText),h([])}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error fetching availability:",e),h([])}},Y=async()=>{if(g&&b&&f&&N){let e=N.trim().split(/\s+/),s=e[0]||N,t=e.slice(1).join(" ")||null;try{let e=await fetch(`${E}/bookings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop_id:n,service_id:g,staff_id:b,start_time:f,end_time:f,first_name:s,last_name:t,notes:`Booking for ${N}`})});if(e.ok)await e.json(),alert(o("booking.bookingSuccessful"));else{let s=await e.json().catch(()=>({error:o("common.unknown")}));alert(`${o("booking.bookingFailed")}: ${s.error||o("common.tryAgain")}`)}}catch(e){e?.message?.includes("Failed to fetch")||e?.message?.includes("ERR_CONNECTION_REFUSED")||(console.error("Error creating booking:",e),alert(o("booking.bookingFailed")))}}};return(0,s.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-6",children:o("booking.bookAppointment")}),(0,s.jsxs)("div",{className:"grid lg:grid-cols-2 gap-8",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:o("booking.chooseService")}),(0,s.jsxs)("select",{value:g||"",onChange:e=>x(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg",children:[(0,s.jsx)("option",{value:"",children:o("booking.selectService")}),i.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:o("booking.chooseStaff")}),(0,s.jsxs)("select",{value:b||"",onChange:e=>y(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg",children:[(0,s.jsx)("option",{value:"",children:o("booking.selectStaff")}),c.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name]},e.id))]})]}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:o("booking.chooseDate")}),(0,s.jsx)("input",{type:"date",value:f||"",onChange:e=>{p(e.target.value)},className:"w-full px-4 py-2 border border-gray-300 rounded-lg"})]}),(0,s.jsx)("div",{className:"mb-6",children:(0,s.jsx)("button",{onClick:V,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:o("booking.checkAvailability")})}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:o("booking.chooseTimeslot")}),(0,s.jsx)("div",{className:"grid grid-cols-2 gap-2",children:u.map(e=>(0,s.jsxs)("button",{onClick:()=>alert(o("booking.timeslotSelected")),className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:[e.start_time," - ",e.end_time]},e.id))})]}),(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-2",children:o("booking.yourInformation")}),(0,s.jsx)("input",{type:"text",placeholder:o("booking.yourName"),value:N,onChange:e=>j(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg mb-2"}),(0,s.jsx)("input",{type:"email",placeholder:o("booking.yourEmail"),value:v,onChange:e=>w(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg"})]}),(0,s.jsx)("button",{onClick:Y,className:"w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700",children:o("booking.submit")})]}),P&&q&&(0,s.jsxs)("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 p-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-4 text-center",children:"LINEã§äºˆç´„ / LINE ã§ãŠå•ã„åˆã‚ã›"}),(0,s.jsxs)("div",{className:"flex flex-col items-center space-y-4",children:[P&&(0,s.jsxs)("div",{className:"flex flex-col items-center",children:[(0,s.jsx)("img",{src:P,alt:"LINE QR Code",className:"w-48 h-48 border-2 border-gray-200 rounded-lg"}),(0,s.jsx)("p",{className:"mt-2 text-sm text-gray-600 text-center",children:"LINEã§äºˆç´„ã¯ã“ã¡ã‚‰"})]}),q&&(0,s.jsx)("a",{href:q,target:"_blank",rel:"noopener noreferrer",className:"px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors",children:"LINEã§äºˆç´„ã¯ã“ã¡ã‚‰"})]})]}),(0,s.jsxs)("div",{className:"bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden flex flex-col h-[600px]",children:[(0,s.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-800",children:"Chat with AI Assistant"}),(0,s.jsx)("button",{onClick:()=>F(!$),className:"text-gray-600 hover:text-gray-900",children:$?"âˆ’":"+"})]}),$&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:0===_.length?(0,s.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-6xl mb-4",children:"ðŸ¤–"}),(0,s.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Start a conversation"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Ask me anything about booking! I can help with appointments, availability, and more."})]})}):(0,s.jsxs)(s.Fragment,{children:[_.map(e=>{let t;return(0,s.jsxs)("div",{className:`flex gap-3 ${"customer"===e.senderType?"justify-end":"justify-start"}`,children:["customer"!==e.senderType&&(0,s.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,s.jsx)("span",{className:"text-lg",children:"ai"===e.senderType?"ðŸ¤–":"ðŸ‘¤"})}),(0,s.jsxs)("div",{className:`max-w-[75%] rounded-lg px-4 py-3 ${"customer"===e.senderType?"bg-blue-600 text-white":"bg-gray-100 text-gray-800"}`,children:[(0,s.jsx)("p",{className:"whitespace-pre-wrap break-words",children:e.content}),(0,s.jsx)("p",{className:`text-xs mt-2 ${"customer"===e.senderType?"text-blue-100":"text-gray-500"}`,children:(t=new Date(e.createdAt),new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"2-digit"}).format(t))})]}),"customer"===e.senderType&&(0,s.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0",children:(0,s.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"You"})})]},e.id)}),R&&(0,s.jsxs)("div",{className:"flex gap-3 justify-start",children:[(0,s.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,s.jsx)("span",{className:"text-lg",children:"ðŸ¤–"})}),(0,s.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]})})]}),(0,s.jsx)("div",{ref:A})]})}),(0,s.jsx)("div",{className:"px-6 py-4 border-t border-gray-200",children:(0,s.jsxs)("form",{onSubmit:e=>{e.preventDefault(),Q()},className:"flex gap-2",children:[(0,s.jsx)("input",{type:"text",value:T,onChange:e=>I(e.target.value),placeholder:"Type your message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none",disabled:R}),(0,s.jsx)("button",{type:"submit",disabled:!T.trim()||R,className:"px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})})]})]})]})]})}e.s(["default",()=>n])}]);
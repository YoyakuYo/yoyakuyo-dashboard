module.exports=[81998,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(67254),e=a.i(3214),f=a.i(15925);function g(){let{user:a}=(0,d.useAuth)(),g=(0,f.useTranslations)(),[h,i]=(0,c.useState)([]),[j,k]=(0,c.useState)(null),[l,m]=(0,c.useState)([]),[n,o]=(0,c.useState)(""),[p,q]=(0,c.useState)(!1),[r,s]=(0,c.useState)(!0),[t,u]=(0,c.useState)(null),[v,w]=(0,c.useState)(!1),[x,y]=(0,c.useState)(!1),[z,A]=(0,c.useState)(new Set),[B,C]=(0,c.useState)("en"),D=(0,c.useRef)(null),E=(0,c.useRef)(null),F=(0,c.useRef)(null),G="http://localhost:3000";(0,c.useEffect)(()=>{D.current?.scrollIntoView({behavior:"smooth"})},[l]),(0,c.useEffect)(()=>{a?.id&&(I(),H())},[a]);let H=async()=>{try{let b=await fetch(`${G}/users/me`,{headers:{"x-user-id":a?.id||""}});if(b.ok){let a=await b.json();C(a.preferredLanguage||"en")}}catch(a){console.error("Error loading owner preferences:",a)}};(0,c.useEffect)(()=>(j&&(J(j),M(j),L(j)),()=>{E.current&&(0,e.getSupabaseClient)().removeChannel(E.current)}),[j]),(0,c.useEffect)(()=>()=>{E.current&&(0,e.getSupabaseClient)().removeChannel(E.current)},[]);let I=async()=>{try{s(!0);let b=await fetch(`${G}/messages/owner/threads`,{headers:{"x-user-id":a?.id||""}});if(b.ok){let a=await b.json();i(Array.isArray(a)?a:[])}else console.error("Failed to load threads"),i([])}catch(a){console.error("Error loading threads:",a),i([])}finally{s(!1)}},J=async a=>{try{let b=await fetch(`${G}/messages/thread/${a}`);if(b.ok){let c=await b.json(),d=Array.isArray(c)?c:[],e=h.find(b=>b.id===a);e&&w(e.ownerTakenOver||!1);let f=await Promise.all(d.map(async a=>{if("owner"===a.senderType)return{...a,originalContent:a.originalContent||a.content,translatedContent:a.content};if("customer"===a.senderType||"ai"===a.senderType){if(a.content&&!a.translatedContent)try{let b=await fetch(`${G}/ai/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:a.content,targetLanguage:B,sourceLanguage:"auto"})});if(b.ok){let c=await b.json();return{...a,originalContent:a.content,translatedContent:c.translatedText||a.content,detectedLanguage:c.sourceLanguage}}}catch(a){console.error("Error translating message:",a)}return{...a,originalContent:a.content,translatedContent:a.translatedContent||a.content}}return a}));m(f)}}catch(a){console.error("Error loading messages:",a)}},K=async()=>{if(!j)return;let a=!v;w(a);try{(await fetch(`${G}/messages/thread/${j}/takeover`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({takenOver:a})})).ok?i(b=>b.map(b=>b.id===j?{...b,ownerTakenOver:a}:b)):(w(!a),console.error("Failed to toggle takeover"))}catch(b){console.error("Error toggling takeover:",b),w(!a)}},L=async a=>{try{await fetch(`${G}/messages/thread/${a}/mark-read-owner`,{method:"POST"}),i(b=>b.map(b=>b.id===a?{...b,unreadCount:0}:b))}catch(a){console.error("Error marking as read:",a)}},M=a=>{E.current=(0,e.getSupabaseClient)().channel(`shop_messages:thread_id=eq.${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"shop_messages",filter:`thread_id=eq.${a}`},async b=>{let c=b.new;c&&c.thread_id===a&&(m(a=>{if(a.some(a=>a.id===c.id))return a;let b={id:c.id,senderType:c.sender_type,content:c.content,createdAt:c.created_at,readByOwner:c.read_by_owner||!1,readByCustomer:c.read_by_customer||!1,senderId:c.sender_id||null,originalContent:c.content,translatedContent:c.content};return("customer"===c.sender_type||"ai"===c.sender_type)&&fetch(`${G}/ai/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:c.content,targetLanguage:B,sourceLanguage:"auto"})}).then(a=>a.json()).then(a=>{m(b=>b.map(b=>b.id===c.id?{...b,translatedContent:a.translatedText||b.content,detectedLanguage:a.sourceLanguage}:b))}).catch(a=>console.error("Error translating new message:",a)),[...a,b]}),i(b=>b.map(b=>b.id===a?{...b,lastMessageAt:c.created_at,lastMessagePreview:c.content?.substring(0,100)||null,lastMessageFrom:c.sender_type,unreadCount:"customer"!==c.sender_type||c.read_by_owner?b.unreadCount:b.unreadCount+1}:b)))}).subscribe()};(0,c.useEffect)(()=>(n.trim()&&j?(y(!0),F.current&&clearTimeout(F.current),F.current=setTimeout(()=>{y(!1)},2e3)):y(!1),()=>{F.current&&clearTimeout(F.current)}),[n,j]);let N=(0,c.useRef)(null),O=async b=>{if(b.preventDefault(),!n.trim()||p||!j)return;y(!1);let c=n.trim();o(""),q(!0),u(null);try{let b=await fetch(`${G}/messages/thread/${j}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderType:"owner",senderId:a?.id||null,content:c})});if(!b.ok){let a=await b.json().catch(()=>({error:"Failed to send message"}));throw Error(a.error||`HTTP error! status: ${b.status}`)}let d=await b.json();m(a=>a.some(a=>a.id===d.id)?a:[...a,d]),i(a=>a.map(a=>a.id===j?{...a,lastMessageAt:d.createdAt,lastMessagePreview:d.content?.substring(0,100)||null,lastMessageFrom:"owner"}:a));let e=h.find(a=>a.id===j);if(e?.shopId)try{await fetch(`${G}/ai/chat-thread`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:j,shopId:e.shopId,message:c,source:"owner"})})}catch(a){console.error("Error triggering AI response:",a)}}catch(a){console.error("Error sending message:",a),u(a instanceof Error?a.message:"Failed to send message")}finally{q(!1),setTimeout(()=>{N.current?.focus()},100)}},P=h.find(a=>a.id===j);return(0,b.jsxs)("div",{className:"p-8 bg-gray-50 min-h-screen",children:[(0,b.jsxs)("div",{className:"mb-6",children:[(0,b.jsx)("h1",{className:"text-3xl font-bold text-gray-800 mb-2",children:g("assistant.title")}),(0,b.jsx)("p",{className:"text-gray-600",children:g("assistant.subtitle")})]}),(0,b.jsx)("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden",children:(0,b.jsxs)("div",{className:"flex h-[calc(100vh-280px)] min-h-[600px]",children:[(0,b.jsxs)("div",{className:"w-80 border-r border-gray-200 flex flex-col bg-gray-50",children:[(0,b.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 bg-white",children:(0,b.jsx)("h2",{className:"text-lg font-semibold text-gray-800",children:g("assistant.customerConversations")})}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto bg-white",children:r?(0,b.jsx)("div",{className:"p-6 text-center text-gray-500",children:g("assistant.loadingThreads")}):0===h.length?(0,b.jsx)("div",{className:"p-6 text-center text-gray-500",children:(0,b.jsx)("p",{children:g("assistant.noConversations")})}):(0,b.jsx)("div",{className:"divide-y divide-gray-100",children:h.map(a=>{let c;return(0,b.jsx)("button",{onClick:()=>k(a.id),className:`w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors ${j===a.id?"bg-blue-50 border-l-4 border-blue-600":""}`,children:(0,b.jsxs)("div",{className:"flex items-start gap-3",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)("span",{className:"text-lg",children:"ðŸ‘¤"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,b.jsx)("p",{className:"text-sm font-semibold text-gray-900 truncate",children:a.customerEmail||`Thread ${a.id.substring(0,8)}`}),a.unreadCount>0&&(0,b.jsx)("span",{className:"ml-2 flex-shrink-0 bg-blue-600 text-white text-xs font-semibold rounded-full px-2 py-0.5 min-w-[20px] text-center",children:a.unreadCount})]}),a.lastMessagePreview&&(0,b.jsx)("p",{className:"text-xs text-gray-500 truncate mb-1",children:a.lastMessagePreview}),(0,b.jsx)("p",{className:"text-xs text-gray-400",children:(c=new Date(a.lastMessageAt),new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}).format(c))})]})]})},a.id)})})})]}),(0,b.jsx)("div",{className:"flex-1 flex flex-col bg-gray-50",children:j?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 bg-white flex items-center justify-between shadow-sm",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:(0,b.jsx)("span",{className:"text-lg",children:"ðŸ‘¤"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-lg font-semibold text-gray-800",children:P?.customerEmail||`Thread ${j.substring(0,8)}`}),P?.bookingId&&(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:[g("assistant.booking")," ",P.bookingId.substring(0,8)]})]})]}),(0,b.jsx)("button",{onClick:K,className:`px-4 py-2 rounded-lg font-medium transition-colors ${v?"bg-green-600 text-white hover:bg-green-700":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:g(v?"assistant.youAreHandling":"assistant.letAiHandle")})]}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50",children:0===l.length?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),(0,b.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:g("assistant.noMessages")}),(0,b.jsx)("p",{className:"text-gray-600",children:g("assistant.startConversation")})]})}):(0,b.jsxs)(b.Fragment,{children:[l.map(a=>{let c;return(0,b.jsxs)("div",{className:`flex gap-3 ${"owner"===a.senderType?"justify-end":"justify-start"}`,children:["owner"!==a.senderType&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)("span",{className:"text-lg",children:"ai"===a.senderType?"ðŸ¤–":"ðŸ‘¤"})}),(0,b.jsxs)("div",{className:`max-w-[75%] rounded-lg px-4 py-3 shadow-sm ${"owner"===a.senderType?"bg-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,children:[(0,b.jsx)("p",{className:"whitespace-pre-wrap break-words",children:"owner"===a.senderType?a.originalContent||a.content:a.translatedContent||a.content}),("customer"===a.senderType||"ai"===a.senderType)&&a.originalContent&&a.originalContent!==a.translatedContent&&(0,b.jsxs)("p",{className:"text-xs mt-1 opacity-75 italic",children:["ðŸ‡¯ðŸ‡µ ",a.originalContent.substring(0,50),a.originalContent.length>50?"...":""]}),(0,b.jsx)("p",{className:`text-xs mt-2 ${"owner"===a.senderType?"text-blue-100":"text-gray-500"}`,children:(c=new Date(a.createdAt),new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"2-digit"}).format(c))})]}),"owner"===a.senderType&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"You"})})]},a.id)}),x&&(0,b.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,b.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}}),(0,b.jsx)("span",{className:"text-xs text-gray-500 ml-2",children:g("assistant.youAreTyping")})]})}),(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)("span",{className:"text-sm font-semibold text-gray-600",children:"You"})})]}),p&&(0,b.jsxs)("div",{className:"flex gap-3 justify-start",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)("span",{className:"text-lg",children:"ðŸ¤–"})}),(0,b.jsx)("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),(0,b.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]})})]}),(0,b.jsx)("div",{ref:D})]})}),(0,b.jsxs)("div",{className:"px-6 py-4 border-t border-gray-200 bg-white sticky bottom-0",children:[t&&(0,b.jsx)("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:t}),(0,b.jsxs)("form",{onSubmit:O,className:"flex gap-2",children:[(0,b.jsx)("input",{ref:N,type:"text",value:n,onChange:a=>o(a.target.value),placeholder:g("assistant.typeMessage"),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none",disabled:p,autoFocus:!0}),(0,b.jsx)("button",{type:"submit",disabled:!n.trim()||p,className:"px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:g(p?"assistant.sending":"assistant.send")})]})]})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full bg-gray-50",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-6xl mb-4",children:"ðŸ’¬"}),(0,b.jsx)("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:g("assistant.selectConversation")}),(0,b.jsx)("p",{className:"text-gray-600",children:g("assistant.selectConversationDesc")})]})})})]})})]})}a.s(["default",()=>g])}];

//# sourceMappingURL=apps_dashboard_app_%28owner%29_assistant_page_tsx_36e92241._.js.map
module.exports=[24387,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(22380),f=a.i(73546),g=a.i(89752),h=a.i(38246),i=a.i(54626);function j({children:a}){return(0,b.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,b.jsx)("header",{className:"bg-white border-b border-gray-200 sticky top-0 z-50",children:(0,b.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,b.jsxs)("div",{className:"flex items-center justify-between h-16",children:[(0,b.jsx)(h.default,{href:"/",className:"text-3xl font-bold text-blue-600 hover:text-blue-700",children:"Yoyaku Yo"}),(0,b.jsx)("nav",{className:"flex items-center gap-4",children:(0,b.jsx)(i.default,{})})]})})}),(0,b.jsx)("main",{children:a})]})}var k=a.i(67254),l=a.i(3214);function m(){let{user:a}=(0,k.useAuth)(),[d,e]=(0,c.useState)(!1),[f,g]=(0,c.useState)([]),[h,i]=(0,c.useState)(""),[j,m]=(0,c.useState)(!1),[n,o]=(0,c.useState)("en"),[p,q]=(0,c.useState)(null),[r,s]=(0,c.useState)(!0),t=(0,c.useRef)(null),u=(0,c.useRef)(null),v="http://localhost:3000";(0,c.useEffect)(()=>{a?.id&&fetch(`${v}/users/me`,{headers:{"x-user-id":a.id}}).then(a=>a.ok?a.json():null).then(a=>{a&&o(a.preferredLanguage||"en")}).catch(a=>{a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading owner language:",a)})},[a,v]);let[w,x]=(0,c.useState)(null);(0,c.useEffect)(()=>{a?.id?fetch(`${v}/shops`,{headers:{"x-user-id":a.id}}).then(a=>a.ok?a.json():null).then(b=>{if(b&&Array.isArray(b)&&b.length>0){let c=b[0].id;x(c),fetch(`${v}/owner/thread?shopId=${c}`,{headers:{"x-user-id":a.id}}).then(a=>a.ok?a.json():null).then(a=>{a?.threadId&&(q(a.threadId),y(a.threadId))}).catch(a=>{a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading owner thread:",a)}).finally(()=>{s(!1)})}else s(!1)}).catch(a=>{a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading shops:",a),s(!1)}):s(!1)},[a,v]);let y=async b=>{try{let c=await fetch(`${v}/messages/thread/${b}`,{headers:{"x-user-id":a?.id||""}});if(c.ok){let a=await c.json(),b=(Array.isArray(a)?a:[]).map(a=>({id:a.id,content:a.content,sender:"owner"===a.senderType?"owner":"bot",timestamp:new Date(a.createdAt)}));g(b)}}catch(a){a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading thread messages:",a)}};(0,c.useEffect)(()=>{if(p&&d){let a=(0,l.getSupabaseClient)();return u.current=a.channel(`owner_messages:thread_id=eq.${p}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"shop_messages",filter:`thread_id=eq.${p}`},a=>{let b=a.new;b&&b.thread_id===p&&g(a=>a.some(a=>a.id===b.id)?a:[...a,{id:b.id,content:b.content,sender:"owner"===b.sender_type?"owner":"bot",timestamp:new Date(b.created_at)}])}).subscribe(),()=>{u.current&&a.removeChannel(u.current)}}},[p,d]),(0,c.useEffect)(()=>{d&&p&&0===f.length&&y(p)},[d,p]),(0,c.useEffect)(()=>{d&&t.current?.scrollIntoView({behavior:"smooth"})},[f,d]);let z=async b=>{if(b.preventDefault(),!h.trim()||j||!w)return;let c=h.trim();i(""),m(!0);let d=`temp_${Date.now()}`,e={id:d,content:c,sender:"owner",timestamp:new Date};g(a=>[...a,e]);try{let b=f.slice(-10).map(a=>({role:"owner"===a.sender?"user":"assistant",content:a.content})),e=await fetch(`${v}/owner/command`,{method:"POST",headers:{"Content-Type":"application/json","x-user-id":a?.id||""},body:JSON.stringify({shopId:w,command:c,ownerLanguage:n,conversationHistory:b,threadId:p})});if(e.ok){let a=await e.json();a.threadId&&!p&&q(a.threadId);let b={id:`temp_${Date.now()+1}`,content:a.message||"Done!",sender:"bot",timestamp:new Date};g(a=>[...a,b]),setTimeout(()=>{g(a=>a.filter(a=>!a.id.startsWith("temp_"))),(a.threadId||p)&&y(a.threadId||p)},1e3)}else{g(a=>a.filter(a=>a.id!==d));let a=await e.json().catch(()=>({})),b={id:(Date.now()+1).toString(),content:`Error: ${a.error||a.message||"Failed to execute command"}`,sender:"bot",timestamp:new Date};g(a=>[...a,b])}}catch(a){if(g(a=>a.filter(a=>a.id!==d)),a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")){let a={id:(Date.now()+1).toString(),content:"Error: API server is not running. Please start the API server.",sender:"bot",timestamp:new Date};g(b=>[...b,a])}else{console.error("Error executing command/chat:",a);let b={id:(Date.now()+1).toString(),content:"Error: Could not execute command or chat",sender:"bot",timestamp:new Date};g(a=>[...a,b])}}finally{m(!1)}};return(0,b.jsxs)(b.Fragment,{children:[!d&&(0,b.jsxs)("button",{onClick:()=>e(!0),className:"fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-50 group","aria-label":"Open AI Assistant",children:[(0,b.jsx)("svg",{className:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,b.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"})}),(0,b.jsx)("span",{className:"absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"})]}),d&&(0,b.jsxs)("div",{className:"fixed bottom-6 right-6 w-96 h-[600px] bg-white rounded-xl shadow-2xl border border-gray-200 flex flex-col z-50",children:[(0,b.jsxs)("div",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-t-xl flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-3 h-3 bg-green-400 rounded-full animate-pulse"}),(0,b.jsx)("h3",{className:"font-bold",children:"ja"===n?"AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ":"AI Assistant"})]}),(0,b.jsx)("button",{onClick:()=>e(!1),className:"text-white hover:text-gray-200 transition-colors",children:(0,b.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,b.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50",children:[0===f.length&&(0,b.jsxs)("div",{className:"text-center text-gray-500 text-sm py-8",children:[(0,b.jsx)("p",{className:"font-medium mb-2",children:"Chat with AI or give commands:"}),(0,b.jsxs)("ul",{className:"text-left space-y-1 text-xs",children:[(0,b.jsx)("li",{children:'â€¢ Commands: "Cancel Mario X44\'s booking"'}),(0,b.jsx)("li",{children:'â€¢ Commands: "Close salon August 10-16"'}),(0,b.jsx)("li",{children:'â€¢ Chat: "How many bookings today?"'}),(0,b.jsx)("li",{children:'â€¢ Chat: "What\'s the weather?"'})]})]}),f.map(a=>(0,b.jsx)("div",{className:`flex ${"owner"===a.sender?"justify-end":"justify-start"}`,children:(0,b.jsx)("div",{className:`max-w-[80%] rounded-lg px-3 py-2 ${"owner"===a.sender?"bg-blue-600 text-white":"bg-white text-gray-900 border border-gray-200"}`,children:(0,b.jsx)("p",{className:"text-sm",children:a.content})})},a.id)),(0,b.jsx)("div",{ref:t})]}),(0,b.jsx)("div",{className:"border-t border-gray-200 p-3 bg-white rounded-b-xl",children:(0,b.jsxs)("form",{onSubmit:z,className:"flex gap-2",children:[(0,b.jsx)("input",{type:"text",value:h,onChange:a=>i(a.target.value),placeholder:"Type a command or chat...",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",disabled:j}),(0,b.jsx)("button",{type:"submit",disabled:j||!h.trim(),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:j?"...":"â†’"})]})})]})]})}var n=a.i(55198);let o="http://localhost:3000",p=[];function q({children:a}){let h=(0,d.usePathname)(),i=(0,c.useMemo)(()=>{let a=h||"";return!!(["/shops","/assistant","/bookings","/settings"].includes(a)||a.startsWith("/shops/services"))},[h]),k=(0,c.useMemo)(()=>p.includes(h||""),[h]);return(console.log("ðŸ”¥ DashboardLayout evaluating route:",h,"| isOwnerRoute:",i,"| isAuthRoute:",k),k)?(0,b.jsx)(b.Fragment,{children:a}):i?(0,b.jsx)(e.default,{children:(0,b.jsxs)(r,{children:[(0,b.jsx)(f.default,{}),(0,b.jsx)(g.default,{}),(0,b.jsx)("main",{className:"lg:ml-64 pt-16 min-h-screen bg-gray-50",children:a}),(0,b.jsx)(m,{})]})}):(console.log("ðŸ”¥ DashboardLayout: Applying PublicLayoutWrapper for public route:",h),(0,b.jsx)(j,{children:a}))}function r({children:a}){return!function(){let{user:a}=(0,k.useAuth)(),{setUnreadBookingsCount:b}=(0,n.useBookingNotifications)(),d=(0,c.useRef)(null),e=(0,c.useRef)([]),f=(0,c.useCallback)(async()=>{if(a?.id)try{let c=await fetch(`${o}/bookings`,{headers:{"x-user-id":a.id}});if(c.ok){let a=await c.json(),d=(Array.isArray(a)?a:[]).filter(a=>"pending"===a.status).length;b(d)}}catch(a){a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error reloading pending bookings count:",a),b(0)}},[a?.id,b]),g=(0,c.useCallback)(()=>{a?.id&&(d.current=(0,l.getSupabaseClient)().channel("booking_notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"bookings"},async a=>{let b=a.new;b&&"pending"===b.status&&(e.current.length>0&&e.current.includes(b.shop_id),await f())}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"bookings"},async a=>{let b=a.new,c=a.old;c?.status==="pending"&&b?.status!=="pending"?await f():c?.status!=="pending"&&b?.status==="pending"&&await f()}).subscribe())},[a?.id,f,b]);(0,c.useEffect)(()=>a?.id?((async()=>{try{let c=await fetch(`${o}/shops`,{headers:{"x-user-id":a.id}});if(c.ok){let d=await c.json();if(e.current=(Array.isArray(d)?d:[]).map(a=>a.id),0===e.current.length)return void b(0);let f=await fetch(`${o}/bookings`,{headers:{"x-user-id":a.id}});if(f.ok){let a=await f.json(),c=(Array.isArray(a)?a:[]).filter(a=>"pending"===a.status).length;b(c)}}}catch(a){a?.message?.includes("Failed to fetch")||a?.message?.includes("ERR_CONNECTION_REFUSED")||console.error("Error loading pending bookings count:",a),b(0)}})(),g(),()=>{d.current&&(0,l.getSupabaseClient)().removeChannel(d.current)}):void b(0),[a,b,g])}(),(0,b.jsx)(b.Fragment,{children:a})}a.s(["default",()=>q],24387)},34664,a=>{"use strict";var b=a.i(87924),c=a.i(32886);function d({locale:a,...d}){if(!a)throw Error(void 0);return(0,b.jsx)(c.IntlProvider,{locale:a,...d})}var e=a.i(72131),f=a.i(82629),g=a.i(52544);let h=f.default&&"object"==typeof f.default?f.default:{},i=g.default&&"object"==typeof g.default?g.default:{};function j({children:a}){let[c,f]=(0,e.useState)("en"),[g,j]=(0,e.useState)(h);(0,e.useEffect)(()=>{f("en"),j(h)},[]),(0,e.useEffect)(()=>{let a=()=>{let a=document.cookie.split(";").find(a=>a.trim().startsWith("yoyaku_yo_language=")),b=null;if(a){let c=a.split("=")[1]?.trim();("en"===c||"ja"===c)&&(b=c)}if(!b){let a=localStorage.getItem("yoyaku_yo_language");("en"===a||"ja"===a)&&(b=a)}b&&f(a=>a!==b?(j("ja"===b?i:h),b):a)};return window.addEventListener("languageChanged",a),window.addEventListener("storage",a),()=>{window.removeEventListener("languageChanged",a),window.removeEventListener("storage",a)}},[]);let k=g&&"object"==typeof g?g:h;return(0,b.jsx)(d,{locale:c,messages:k,onError:a=>{},getMessageFallback:({namespace:a,key:b,error:d})=>"shops.photos"===b?"ja"===c?"å†™çœŸ":"Photos":b.startsWith("cities.")||b.startsWith("prefectures.")?(b.split(".").pop()||b).replace(/[-_]/g," ").replace(/\b\w/g,a=>a.toUpperCase()).trim():b,children:a})}a.s(["NextIntlProviderWrapper",()=>j],34664)}];

//# sourceMappingURL=apps_dashboard_app_components_6ecab853._.js.map
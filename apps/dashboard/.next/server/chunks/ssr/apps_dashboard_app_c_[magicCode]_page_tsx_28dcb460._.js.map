{"version":3,"sources":["../../../../../../apps/dashboard/app/c/%5BmagicCode%5D/page.tsx"],"sourcesContent":["// apps/dashboard/app/c/[magicCode]/page.tsx\r\n// Customer permanent chat page with magic code URL\r\n\r\n\"use client\";\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport { getSupabaseClient } from '@/lib/supabaseClient';\r\n\r\ninterface Message {\r\n  id: string;\r\n  sender_type: 'customer' | 'ai' | 'owner';\r\n  content: string;\r\n  created_at: string;\r\n  originalContent?: string;\r\n  translatedContent?: string;\r\n  detectedLanguage?: string;\r\n}\r\n\r\ninterface Customer {\r\n  id: string;\r\n  customer_id_display: string;\r\n  first_name: string;\r\n  last_name: string;\r\n  preferred_language: string;\r\n  threadId?: string | null; // Thread ID for customer chat\r\n  shopId?: string; // Shop ID\r\n}\r\n\r\nexport default function CustomerChatPage() {\r\n  const params = useParams();\r\n  const router = useRouter();\r\n  const magicCode = params.magicCode as string;\r\n  const [customer, setCustomer] = useState<Customer | null>(null);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [initializing, setInitializing] = useState(true);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';\r\n  const supabase = getSupabaseClient();\r\n\r\n  // Initialize customer from magic code\r\n  useEffect(() => {\r\n    if (!magicCode) return;\r\n\r\n    const initializeCustomer = async () => {\r\n      try {\r\n        // Find customer by magic code\r\n        const res = await fetch(`${apiUrl}/customers/magic/${magicCode}`);\r\n        if (res.ok) {\r\n          const data = await res.json();\r\n          setCustomer(data);\r\n          \r\n          // Load chat history\r\n          if (data.threadId) {\r\n            loadMessages(data.threadId);\r\n          }\r\n        } else {\r\n          console.error('Customer not found');\r\n        }\r\n      } catch (error) {\r\n        console.error('Error initializing customer:', error);\r\n      } finally {\r\n        setInitializing(false);\r\n      }\r\n    };\r\n\r\n    initializeCustomer();\r\n  }, [magicCode, apiUrl]);\r\n\r\n  // Load messages\r\n  const loadMessages = async (threadId: string) => {\r\n    try {\r\n      const res = await fetch(`${apiUrl}/messages/thread/${threadId}`);\r\n      if (res.ok) {\r\n        const data = await res.json();\r\n        // API returns messages directly as an array, not wrapped in a messages property\r\n        const messagesData = Array.isArray(data) ? data : [];\r\n        setMessages(messagesData);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading messages:', error);\r\n    }\r\n  };\r\n\r\n  // Subscribe to real-time messages\r\n  useEffect(() => {\r\n    if (!customer?.threadId) return;\r\n\r\n    const channel = supabase\r\n      .channel(`thread-${customer.threadId}`)\r\n      .on('postgres_changes', {\r\n        event: 'INSERT',\r\n        schema: 'public',\r\n        table: 'shop_messages',\r\n        filter: `thread_id=eq.${customer.threadId}`,\r\n      }, (payload: any) => {\r\n        const newMessage = payload.new;\r\n        setMessages(prev => [...prev, newMessage]);\r\n      })\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, [customer?.threadId, supabase]);\r\n\r\n  // Scroll to bottom\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Send message\r\n  const handleSend = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!input.trim() || loading || !customer) return;\r\n\r\n    const messageText = input.trim();\r\n    setInput('');\r\n    setLoading(true);\r\n\r\n    try {\r\n      // Send message\r\n      const res = await fetch(`${apiUrl}/messages/thread/${customer.threadId}/send`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          senderType: 'customer',\r\n          content: messageText,\r\n        }),\r\n      });\r\n\r\n      if (res.ok) {\r\n        // Trigger AI response\r\n        await fetch(`${apiUrl}/ai/chat-thread`, {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            threadId: customer.threadId,\r\n            shopId: customer.shopId,\r\n            message: messageText,\r\n            source: 'customer',\r\n          }),\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n    } finally {\r\n      setLoading(false);\r\n      // Keep input focused after sending\r\n      setTimeout(() => {\r\n        inputRef.current?.focus();\r\n      }, 100);\r\n    }\r\n  };\r\n\r\n  if (initializing) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\r\n          <p className=\"text-gray-600\">Loading your chat...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!customer) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\r\n        <div className=\"text-center\">\r\n          <h1 className=\"text-2xl font-bold text-gray-900 mb-2\">Chat Not Found</h1>\r\n          <p className=\"text-gray-600\">This chat link is invalid or has expired.</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col\">\r\n      {/* Header */}\r\n      <div className=\"bg-white shadow-sm border-b border-gray-200 px-6 py-4\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">\r\n            {customer.customer_id_display}さん\r\n          </h1>\r\n          <p className=\"text-sm text-gray-600\">Your permanent chat</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      <div className=\"flex-1 overflow-y-auto px-4 py-6\">\r\n        <div className=\"max-w-4xl mx-auto space-y-4\">\r\n          {messages.map((msg) => (\r\n            <div\r\n              key={msg.id}\r\n              className={`flex ${msg.sender_type === 'customer' ? 'justify-end' : 'justify-start'}`}\r\n            >\r\n              <div\r\n                className={`max-w-[80%] rounded-lg px-4 py-2 ${\r\n                  msg.sender_type === 'customer'\r\n                    ? 'bg-blue-600 text-white'\r\n                    : msg.sender_type === 'owner'\r\n                    ? 'bg-purple-600 text-white'\r\n                    : 'bg-white text-gray-900 border border-gray-200'\r\n                }`}\r\n              >\r\n                <p className=\"text-sm\">{msg.translatedContent || msg.content}</p>\r\n                {msg.originalContent && msg.originalContent !== msg.translatedContent && (\r\n                  <p className=\"text-xs mt-1 opacity-75 italic\">\r\n                    {msg.originalContent.substring(0, 50)}...\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          ))}\r\n          <div ref={messagesEndRef} />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Input */}\r\n      <div className=\"bg-white border-t border-gray-200 px-4 py-4\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <form onSubmit={handleSend} className=\"flex gap-2\">\r\n            <input\r\n              ref={inputRef}\r\n              type=\"text\"\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              placeholder=\"Type your message...\"\r\n              className=\"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n              disabled={loading}\r\n              autoFocus\r\n            />\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading || !input.trim()}\r\n              className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n            >\r\n              {loading ? 'Sending...' : 'Send'}\r\n            </button>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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"}